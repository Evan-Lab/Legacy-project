{# 
  Generated by JinjaGenerator for template 'carrousel'
    at 2025-10-29T22:34:57.217834

  Used macros:
  - alert_header()
  - alert_content()
  - alert_color()
  - anc_name(lll)
  - input_snd(xxx, yyy)

  Used includes:
  - css
  - trl
  - copyr
  - js

  Used variables:
  - lang (x1)
  - index (x14)
  - body_prop (x1)
  - include.hed (x1)
  - include.perso_header (x1)
  - message_to_wizard (x1)
  - random.init (x1)
  - random.bits (x1)
  - predictable_mode (x1)
  - portrait (x7)
  - old_portrait (x5)
  - e.mode (x14)
  - e.em (x29)
  - e.notes (x1)
  - e.delete (x7)
  - e.file_name_2 (x1)
  - e.file_name (x17)
  - e.b (x3)
  - images_store (x12)
  - X (x56)
  - keydir (x4)
  - carrousel (x8)
  - portraits_store (x11)
  - portrait_name (x4)
  - old_portraits_store (x7)
  - blason_name (x4)
  - ext (x1)
  - reorg (x3)
  - base.name (x6)
  - wizard (x1)
  - has_portrait (x7)
  - has_portrait_url (x3)
  - action (x3)
  - cgi (x3)
  - has_blason (x5)
  - has_old_blason (x3)
  - has_old_portrait (x2)
  - portrait_url (x3)
  - sp (x5)
  - old_portrait_url (x3)
  - has_old_portrait_url (x1)
  - old_portrait_name (x3)
  - has_blason_stop (x2)
  - reset_count (x2)
  - reset_count1 (x1)
  - has_blason_self (x2)
  - count1 (x1)
  - blason_url (x6)
  - blason (x2)
  - self (x1)
  - blason_owner.access (x2)
  - blason_owner (x3)
  - blason_stop_name (x1)
  - old_blason_url (x3)
  - old_blason_name (x2)
  - old_blason (x1)
  - carrousel_img_nbr (x2)
  - carrousel_old_img_nbr (x2)
  - query_time (x1)
#}

<!DOCTYPE html>
<html lang="{{ lang }}">
    <head>
        <!-- $Id: carrousel.txt v7.1 17/01/2025 07:39:24 $ -->
        <title>{{ _("add") |capitalize }}/{{ _('delete::image/images', variant='0') }} #{{ index }}</title>
        <meta name="robots" content="none">
        <meta charset="UTF-8">
        <meta name="viewport"
              content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="shortcut icon"
              href="{{ url_for("static", path="images/favicon_gwd.png") }}">
        {% include 'css.html.j2' %}
    </head>
    <body {{ body_prop }} id="person">
        {{ include.hed }}
        <div class="container">
            {{ message_to_wizard }}{{ include.perso_header }}{{ random.init }}
            {% with %}
                {% set random_bits = ("123456") if (predictable_mode) else (random.bits) %}
                {% macro alert_header() %}
                    {% if "http" in portrait or "http" in old_portrait %}
                        WARNING
                    {% else %}
                        {% if e.mode == "carrousel" %}
                            {% if e.em == "SND_IMAGE_C_OK" %}
                                {{ _("image received") |capitalize }}
                                {% if e.notes != "" %}{{ _("with note") }}{% endif %}
                            {% else %}
                                {% if e.em == "DEL_IMAGE_C_OK" %}
                                    {{ _("image deleted") |capitalize }}
                                    {% if e.delete != "on" %}{{ _("and") }} {{ _('saved', variant='1') }}{% endif %}
                                {% else %}
                                    {% if e.em == "RESET_IMAGE_C_OK" %}
                                        {{ _('image/images', variant='0') |capitalize }} {{ _('copied/copied', variant='1') }}
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        {% else %}
                            {% if e.mode == "blasons" %}
                                {% if e.em == "SND_IMAGE_C_OK" %}
                                    {{ _('blason/blasons', variant='0') |capitalize }} {{ _('uploaded', variant='0') }}
                                {% else %}
                                    {% if e.em == "DEL_IMAGE_C_OK" %}
                                        {{ _('blason/blasons', variant='0') |capitalize }} {{ _('deleted', variant='0') }}
                                        {% if e.delete != "on" %}{{ _("and") }} {{ _('saved', variant='0') }}{% endif %}
                                    {% else %}
                                        {% if e.em == "RESET_IMAGE_C_OK" %}
                                            {{ _('blason/blasons', variant='0') |capitalize }} {{ _('restored', variant='0') }}
                                        {% else %}
                                            {% if e.em == "IMAGE_TO_BLASON" %}
                                                {{ _('image/images', variant='0') |capitalize }} {{ _('copied/copied', variant='1') }} {{ _("to") }} {{ _('blason/blasons', variant='0') }}
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                {% if e.mode == "portraits" %}
                                    {% if e.em == "SND_IMAGE_C_OK" %}
                                        {% if e.mode == "note" %}
                                            {{ _("note") |capitalize }} {{ _("update") }}
                                        {% else %}
                                            {{ _("portrait") |capitalize }} {{ _('uploaded', variant='0') }}
                                        {% endif %}
                                    {% else %}
                                        {% if e.em == "DEL_IMAGE_C_OK" %}
                                            {{ _("portrait") |capitalize }} {{ _('deleted', variant='0') }}
                                            {% if e.delete != "on" %}{{ _("and") }} {{ _('saved', variant='0') }}{% endif %}
                                        {% else %}
                                            {% if e.em == "RESET_IMAGE_C_OK" %}{{ _("portrait") |capitalize }} {{ _('restored', variant='0') }}{% endif %}
                                        {% endif %}
                                    {% endif %}
                                {% else %}
                                    {% if e.mode == "note" %}
                                        {% if e.em == "SND_IMAGE_C_OK" %}{{ _('note/notes', variant='0') |capitalize }} {{ _("update::") }}{% endif %}
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% endmacro %}
                {% macro alert_content() %}
                    {% if "http" in portrait or "http" in old_portrait %}
                        Update image field with <a href="/m=MOD_IND;i={{ index }}">MOD_IND</a>
                    {% else %}
                        {% if e.mode == "note" %}
                            <strong>></strong> {{ images_store }}{{ X }}{{ e.file_name_2 }}
                        {% else %}
                            {% if e.mode == "carrousel" %}
                                <samp>
                                    {% if e.em == "SND_IMAGE_C_OK" %}
                                        <strong>></strong> {{ images_store }}{{ X }}{{ e.file_name }}
                                    {% else %}
                                        {% if e.em == "DEL_IMAGE_C_OK" %}
                                            {% if e.delete == "on" %}
                                                {{ images_store }}{{ X }}{{ keydir }}{{ X }}{{ e.file_name }}
                                            {% else %}
                                                {{ images_store }}|{{ X }}|{{ carrousel }}|{{ X }}|{{ e.file_name }} <strong>></strong>
                                                {{ images_store }}{{ X }}{{ keydir }}{{ X }}{{ e.file_name }}
                                            {% endif %}
                                        {% else %}
                                            {% if e.em == "RESET_IMAGE_C_OK" %}
                                                {{ images_store }}{{ X }}{{ keydir }}{{ X }}{{ e.file_name }} <strong><></strong> {{ images_store }}{{ X }}{{ e.file_name }}
                                            {% else %}
                                                bad command {{ e.em }} ({{ e.mode }})
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                </samp>
                            {% else %}
                                {% if e.mode == "portraits" %}
                                    <samp>
                                        {% if e.em == "SND_IMAGE_C_OK" %}
                                            {{ portraits_store }}{{ X }}{{ portrait_name }}
                                        {% else %}
                                            {% if e.em == "DEL_IMAGE_C_OK" %}
                                                {% if e.delete == "on" %}
                                                    {{ old_portraits_store }}{{ X }}{{ e.file_name }}
                                                {% else %}
                                                    {{ portraits_store }}{{ X }}{{ e.file_name }} <strong>></strong> {{ old_portraits_store }}{{ X }}{{ e.file_name }}
                                                {% endif %}
                                            {% else %}
                                                {% if e.em == "RESET_IMAGE_C_OK" %}
                                                    {{ portraits_store }}{{ X }}{{ carrousel }}{{ X }}saved{{ X }}{{ e.file_name }} <strong><></strong> {{ portraits_store }}{{ X }}{{ carrousel }}{{ X }}{{ e.file_name }}
                                                {% else %}
                                                    bad command {{ e.em }} ({{ e.mode }})
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}
                                    </samp>
                                {% else %}
                                    {% if e.mode == "blasons" %}
                                        <samp>
                                            {% if e.em == "SND_IMAGE_C_OK" %}
                                                {{ portraits_store }}{{ X }}{{ carrousel }}{{ X }}{{ blason_name }}
                                            {% else %}
                                                {% if e.em == "DEL_IMAGE_C_OK" %}
                                                    {% if e.delete == "on" %}
                                                        {{ portraits_store }}{{ X }}saved{{ X }}{{ e.file_name }}
                                                    {% else %}
                                                        {{ portraits_store }}{{ X }}{{ e.file_name }} <strong>></strong> {{ old_portraits_store }}{{ X }}{{ e.file_name }}
                                                    {% endif %}
                                                {% else %}
                                                    {% if e.em == "RESET_IMAGE_C_OK" %}
                                                        {{ old_portraits_store }}{{ X }}{{ e.file_name }} <strong><></strong> {{ portraits_store }}{{ X }}{{ e.file_name }}
                                                    {% else %}
                                                        {% if e.em == "IMAGE_TO_BLASON" %}
                                                            {{ images_store }}{{ X }}{{ e.file_name }} <strong><></strong> {{ portraits_store }}{{ X }}{{ keydir }}.blason{{ ext }}
                                                        {% else %}
                                                            bad command {{ e.em }} {{ e.mode }}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                        </samp>
                                    {% else %}
                                        bad command: {{ e.em }} ({{ e.mode }})
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% endmacro %}
                {% macro alert_color() %}
                    {% if "http" in portrait or "http" in old_portrait %}
                        danger
                    {% else %}
                        {% if e.mode == "note" %}
                            primary
                        {% else %}
                            {% if e.em == "SND_IMAGE_C_OK" or e.em == "RESET_IMAGE_C_OK" %}
                                success
                            {% else %}
                                {% if e.em == "DEL_IMAGE_C_OK" and e.delete == "on" %}
                                    danger
                                {% else %}
                                    warning
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% endmacro %}
                {% with %}
                    {% set portraits_store = (base.name+".gwb"+X+"documents"+X+"portraits") if (reorg) else ("images"+X+base.name) %}
                    {% with %}
                        {% set old_portraits_store = (base.name+".gwb"+X+"documents"+X+"portraits"+X+"saved") if (reorg) else ("images"+X+base.name+X+"saved") %}
                        {% with %}
                            {% set images_store = (base.name+".gwb"+X+"documents"+X+"images") if (reorg) else ("src"+X+base.name+X+"images") %}
                            {% macro anc_name(lll) %}
                                {{ _('cousin.lll.0', variant='0') }}
                            {% endmacro %}
                            {% if wizard %}
                                <div class="row mb-1">
                                    <div class="col-6 border border-bottom-0 border-top-0 border-left-0">
                                        <div class="d-inline-flex">
                                            <h1 class="display-5">
                                                {% if has_portrait %}
                                                    {{ _("modify portrait") |capitalize }}
                                                {% else %}
                                                    {{ _("add portrait") |capitalize }}
                                                {% endif %}
                                            </h1>
                                            {% if has_portrait or has_portrait_url %}
                                                <abbr class="ml-2 mt-2 text-primary small"
                                                      data-toggle="tooltip"
                                                      data-html="true"
                                                      data-placement="top"
                                                      title="{% if has_portrait_url %}{{ _("must use MOD_IND") |capitalize }}{% else %}{% if has_portrait %}{{ _("previous portrait") |capitalize }}{% endif %}{% endif %}">
                                                (<i class="fa fa-info fa-xs"></i>)</abbr>
                                            {% endif %}
                                        </div>
                                        <form class="form-row"
                                              method="post"
                                              action="{{ action }}"
                                              enctype="multipart/form-data">
                                            {% if cgi %}<input type="hidden" name="b" value="{{ e.b }}">{% endif %}
                                            <input type="hidden" name="m" value="SND_IMAGE_C_OK">
                                            <input type="hidden" name="i" value="{{ index }}">
                                            <input type="hidden" name="notes" value="">
                                            <input type="hidden" name="mode" value="portraits">
                                            <div class="custom-file col">
                                                <input type="file"
                                                       name="file"
                                                       class="custom-file-input custom-portrait"
                                                       id="portrait_file"
                                                       accept="image/*"
                                                       {% if not has_portrait %}autofocus{% endif %}>
                                                <label class="custom-file-label text-truncate"
                                                       data-browse="{{ _("browse") |capitalize }}"
                                                       for="portrait_file">
                                                    {{ _("select") |capitalize }} {{ _('image/images', variant='0') }}
                                                </label>
                                            </div>
                                            <button class="btn btn-primary ml-2 col-2 snd-btn-portrait"
                                                    type="submit"
                                                    disabled>{{ _("send::") |capitalize }}</button>
                                        </form>
                                        <h1 class="display-5">
                                            {% if has_blason %}
                                                {{ _("modify coat of arms") |capitalize }}
                                            {% else %}
                                                {{ _("add coat of arms") |capitalize }}
                                            {% endif %}
                                        </h1>
                                        <form class="form-row"
                                              method="post"
                                              action="{{ action }}"
                                              enctype="multipart/form-data">
                                            {% if cgi %}<input type="hidden" name="b" value="{{ e.b }}">{% endif %}
                                            <input type="hidden" name="m" value="SND_IMAGE_C_OK">
                                            <input type="hidden" name="i" value="{{ index }}">
                                            <input type="hidden" name="notes" value="">
                                            <input type="hidden" name="mode" value="blasons">
                                            <div class="custom-file col">
                                                <input type="file"
                                                       name="file"
                                                       class="custom-file-input custom-blason"
                                                       id="portrait_file"
                                                       accept="image/*"
                                                       {% if not has_blason %}autofocus{% endif %}>
                                                <label class="custom-file-label text-truncate"
                                                       data-browse="{{ _("browse") |capitalize }}"
                                                       for="portrait_file">
                                                    {{ _("select") |capitalize }} {{ _('blason/blasons', variant='0') }}
                                                </label>
                                            </div>
                                            <button class="btn btn-primary ml-2 col-2 snd-btn-blason"
                                                    type="submit"
                                                    disabled>{{ _("send::") |capitalize }}</button>
                                        </form>
                                        <div class="small mt-2">
                                            {% if has_blason and has_old_blason %}{{ _('previous::blason/blasons', variant='0') |capitalize }}{% endif %}
                                        </div>
                                        <div class="d-inline-flex">
                                            <h1 class="display-5">{{ _("add image") |capitalize }}</h1>
                                            <abbr class="ml-2 mt-2 text-primary small"
                                                  data-toggle="tooltip"
                                                  data-html="true"
                                                  data-placement="top"
                                                  title="{{ _("previous image") |capitalize }}">(<i class="fa fa-info fa-xs"></i>)</abbr>
                                        </div>
                                        <form class="form-row"
                                              method="post"
                                              action="{{ action }}"
                                              enctype="multipart/form-data">
                                            {% if cgi %}<input type="hidden" name="b" value="{{ e.b }}">{% endif %}
                                            <input type="hidden" name="m" value="SND_IMAGE_C_OK">
                                            <input type="hidden" name="i" value="{{ index }}">
                                            <input type="hidden" name="mode" id="mode_2" value="carrousel">
                                            <input type="hidden" name="file_name_2" id="file_name_2" value="">
                                            <div class="custom-file col">
                                                <input type="file"
                                                       name="file"
                                                       class="custom-file-input custom-others"
                                                       id="others_file"
                                                       accept="image/*"
                                                       {% if has_portrait %}autofocus{% endif %}>
                                                <label class="custom-file-label text-truncate"
                                                       data-browse="{{ _("browse") |capitalize }}"
                                                       for="others_file">
                                                    {{ _("select") |capitalize }} {{ _('image/images', variant='0') }}
                                                </label>
                                            </div>
                                            <button type="button"
                                                    class="btn btn-primary ml-2 col-2 btn-quick-upload"
                                                    disabled>{{ _("send::") |capitalize }}</button>
                                            <div class="col-12 mt-2 px-0">
                                                <div class="d-flex align-items-center">
                                                    <span class="mr-2">{{ _("or") }}</span>
                                                    <input type="text"
                                                           class="form-control"
                                                           id="image_url"
                                                           name="image_url"
                                                           placeholder="{{ a_of_b(_('URL') , _('image/images', variant='0')) }}">
                                                    <input type="text"
                                                           class="form-control ml-1"
                                                           id="image_name"
                                                           name="image_name"
                                                           placeholder="{{ _("name") |capitalize }}"
                                                           disabled>
                                                </div>
                                            </div>
                                            <div class="mt-3 mb-2 w-100">
                                                <textarea class="form-control" id="image_note" disabled name="note" rows="2" placeholder="{{ _('note/notes', variant='0')|capitalize }} ({{ _('optional') }})">
</textarea>
                                            </div>
                                            <textarea class="form-control w-100" id="image_source" disabled name="source" rows="1" placeholder="{{ _('source/sources', variant='0')|capitalize }} ({{ _('optional') }})">
</textarea>
                                            <div class="col-12 mt-2 px-0">
                                                <div class="d-flex">
                                                    <button type="submit"
                                                            class="flex-grow-1 btn btn-primary text-wrap text-left py-2 submit-button"
                                                            disabled>
                                                        <span id="which_img_show" class="d-inline-block">{{ _("send image with note and source") |capitalize }}</span>
                                                    </button>
                                                    <button type="button"
                                                            class="btn btn-secondary ml-2 d-none"
                                                            id="btn-cancel-edit">
                                                        {{ _('user/password/cancel', variant='2') |capitalize }}
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="col-6">
                                        {% if has_portrait or has_old_portrait %}
                                            <h1 class="display-5">{{ _('portrait', variant='0') |capitalize }}</h1>
                                            {% if has_portrait %}
                                                <div class="d-flex mt-1">
                                                    <a role="button"
                                                       href="{{ portrait_url }}"
                                                       target="_blank"
                                                       rel="noopener"
                                                       {{ sp }}
                                                       data-toggle="tooltip"
                                                       data-html="true"
                                                       data-placement="left"
                                                       title='<strong>{{ _("see portrait") |capitalize }}</strong><br><span class="small">{{ portrait }}</span><br> <img class="rounded my-1" src="{{ portrait_url }}" width="185px">'>
                                                        <i class="far fa-file-image fa-fw text-primary"></i></a>
                                                    <a href="/m=PORTRAIT_TO_BLASON&i={{ index }}"
                                                       class="mx-1"
                                                       title="{{ _("copy portrait to blason") |capitalize }}">
                                                        <i class="fa fa-user-shield"></i></a>
                                                    {% if has_portrait_url %}
                                                        {{ portrait_name }}
                                                    {% else %}
                                                        <strong><samp class="text-truncate">{{ portraits_store }}{{ X }}</samp></strong><samp>{{ portrait_name }}
                                                        {% endif %}
                                                    </samp>
                                                    <a role="button"
                                                       class="ml-auto"
                                                       href="/m=DEL_IMAGE_C_OK&i={{ index }}&mode=portraits&file_name={{ portrait_name }}"
                                                       data-toggle="tooltip"
                                                       data-html="true"
                                                       data-placement="left"
                                                       title='<i class="far fa-trash-can text-warning mr-1"></i><strong>{{ _("delete portrait") |capitalize }}</strong><br><span class="small">{{ portrait }}</span><br> <img class="rounded my-1" src="{{ portrait_url }}" width="185px">'>
                                                        <i class="far fa-trash-can text-warning mr-1"></i></a>
                                                </div>
                                            {% endif %}
                                            {% if has_old_portrait %}
                                                <div class="d-flex">
                                                    <a role="button"
                                                       href="{{ old_portrait_url }}"
                                                       target="_blank"
                                                       rel="noopener"
                                                       {{ sp }}
                                                       data-toggle="tooltip"
                                                       data-html="true"
                                                       data-placement="left"
                                                       title='<strong>{{ _("see portrait") |capitalize }}</strong><br><span class="small">{{ old_portrait }}</span><br> <img class="rounded my-1" src="{{ old_portrait_url }}" width="185px">'>
                                                        <i class="far fa-file-image fa-fw text-primary"></i></a>
                                                    <a role="button"
                                                       href="/m=RESET_IMAGE_C_OK&i={{ index }}&mode=portraits&file_name={{ portrait }}"
                                                       title="{{ _("restore portrait saved") |capitalize }}">
                                                        <i class="fa fa-retweet fa-rotate-90 fa-fw text-success"></i></a>
                                                    {% if has_old_portrait_url %}
                                                        <strong><samp class="text-truncate">{{ old_portraits_store }}{{ X }}</samp></strong>{{ old_portrait_name }}
                                                    {% else %}
                                                        <strong><samp class="text-truncate">{{ old_portraits_store }}{{ X }}</samp></strong><samp>{{ old_portrait_name }}
                                                        {% endif %}
                                                    </samp>
                                                    <a role="button"
                                                       class="ml-auto"
                                                       href="/m=DEL_IMAGE_C_OK&i={{ index }}&mode=portraits&delete=on&file_name={{ old_portrait_name }}"
                                                       data-toggle="tooltip"
                                                       data-html="true"
                                                       data-placement="left"
                                                       title='<i class="far fa-trash-can text-danger mr-1"></i><strong>{{ _('delete saved portrait', variant='0') |capitalize }}</strong><br><span class="small">{{ old_portrait }}</span><br> <img class="rounded my-1" src="{{ old_portrait_url }}" width="185px">'>
                                                        <i class="far fa-trash-can text-danger"></i></a>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                        {% if has_blason or has_blason_stop or has_old_blason %}
                                            <div class="d-flex justify-content-between">
                                                <h1 class="display-5">{{ _('blason/blasons', variant='0') |capitalize }}</h1>
                                                {{ reset_count }}{{ reset_count1 }}{# foreach not implemented yet #}
                                                <div class="dropdown align-self-center">
                                                    {% if has_blason_self and count1 > 0 %}
                                                        <button class="btn btn-sm btn-light dropdown-toggle"
                                                                type="button"
                                                                id="dropdownMenuButton"
                                                                title="{{ _('move coat of arms to', variant='1') |capitalize }}"
                                                                data-toggle="dropdown"
                                                                aria-haspopup="true"
                                                                aria-expanded="false">
                                                            <i class="fa fa-person-arrow-up-from-line pb-0"></i>
                                                        </button>
                                                        <div class="dropdown-menu dropdown-menu-right"
                                                             aria-labelledby="dropdownMenuButton">
                                                            {{ reset_count }}{# foreach not implemented yet #}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if has_blason_self %}
                                                <div class="d-flex align-self-center mt-1">
                                                    <a role="button"
                                                       href="{{ blason_url }}"
                                                       target="_blank"
                                                       rel="noopener"
                                                       data-toggle="tooltip"
                                                       data-html="true"
                                                       data-placement="left"
                                                       title='<strong>{{ _("see coat of arms") |capitalize }}</strong><br><span class="small">{{ blason_url }}</span><br> <img class="rounded my-1" src="{{ blason_url }}" width="185px">'>
                                                        <i class="far fa-file-image fa-fw text-primary"></i></a>
                                                    <strong><samp class="text-truncate">{{ portraits_store }}{{ X }}</samp></strong><samp>{{ blason_name }}</samp>
                                                    <a role="button"
                                                       class="ml-auto col-1"
                                                       href="/m=DEL_IMAGE_C_OK&i={{ index }}&mode=blasons&file_name={{ blason_name }}"
                                                       data-toggle="tooltip"
                                                       data-html="true"
                                                       data-placement="left"
                                                       title='<i class="far fa-trash-can text-warning mr-1"></i><strong>{{ _("delete coat of arms") |capitalize }}</strong><br><span class="small">{{ blason }}</span><br> <img class="rounded my-1" src="{{ blason_url }}" width="185px">'>
                                                        <i class="far fa-trash-can text-warning"></i></a>
                                                </div>
                                            {% else %}
                                                {% if has_blason_stop %}
                                                    <div class="d-flex mt-1">
                                                        <span>{{ self }} {{ _('stop using the coat of arms of', variant='1') |capitalize }} <a href="/{{ blason_owner.access }}">{{ blason_owner }}</a></span><a role="button"
   class="ml-auto col-1"
   href="/m=DEL_IMAGE_C_OK&i={{ index }}&mode=blasons&file_name={{ blason_stop_name }}"
   data-toggle="tooltip"
   data-html="true"
   data-placement="left">
                                                            <i class="far fa-trash-can text-warning"></i></a>
                                                    </div>
                                                {% else %}
                                                    {% if has_blason %}
                                                        <div class="d-flex mt-1">
                                                            <a role="button"
                                                               href="{{ blason_url }}"
                                                               target="_blank"
                                                               rel="noopener"
                                                               data-toggle="tooltip"
                                                               data-html="true"
                                                               data-placement="left"
                                                               title='<strong>{{ _("see coat of arms") |capitalize }}</strong><br><span class="small">{{ blason_name }}</span><br><img class="rounded my-1"{{ sp }}src="{{ blason_url }}" width="185px">'>
                                                                <i class="far fa-file-image fa-fw text-primary"></i></a>
                                                            <span>{{ _('use coat of arms of', variant='0') |capitalize }}{{ sp }}<a href="/{{ blason_owner.access }}">{{ blason_owner }}</a></span>
                                                            <a role="button"
                                                               class="ml-auto"
                                                               href="/m=BLASON_STOP&i={{ index }}&mode=blasons"
                                                               title="{{ _('stop using the coat of arms of', variant='0') |capitalize }} {{ blason_owner }}"
                                                               data-toggle="tooltip"
                                                               data-html="true"
                                                               data-placement="left">
                                                                <i class="fa-solid fa-xmark fa-fw fa-xl text-danger"></i></a>
                                                        </div>
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                            {% if has_old_blason %}
                                                <div class="d-flex mt-1">
                                                    <a role="button"
                                                       href="{{ old_blason_url }}"
                                                       target="_blank"
                                                       rel="noopener"
                                                       data-toggle="tooltip"
                                                       data-html="true"
                                                       data-placement="left"
                                                       title='<strong>{{ _("see coat of arms") |capitalize }}</strong><br><span class="small">{{ blason }}</span><br> <img class="rounded my-1" width="185px" src="{{ old_blason_url }}">'>
                                                        <i class="far fa-file-image fa-fw text-primary"></i></a>
                                                    <a role="button"
                                                       href="/m=RESET_IMAGE_C_OK&i={{ index }}&mode=blasons&file_name={{ portrait }}"
                                                       title="{{ _("restore coat of arms saved") |capitalize }}">
                                                        <i class="fa fa-retweet fa-rotate-90 fa-fw text-success"></i></a>
                                                    <strong><samp class="text-truncate">{{ old_portraits_store }}{{ X }}</samp></strong><samp>{{ old_blason_name }}</samp>
                                                    <a role="button"
                                                       class="ml-auto col-1"
                                                       href="/m=DEL_IMAGE_C_OK&i={{ index }}&mode=blasons&delete=on&file_name={{ old_blason_name }}"
                                                       data-toggle="tooltip"
                                                       data-html="true"
                                                       data-placement="left"
                                                       {{ sp }}
                                                       title='<strong>{{ _('delete saved coat of arms', variant='0') |capitalize }}</strong><br><span class="small">{{ old_blason }}</span><br> <img class="rounded my-1" src="{{ old_blason_url }}" width="185px">'>
                                                        <i class="far fa-trash-can text-danger"></i></a>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                        {% if carrousel_img_nbr > 0 %}
                                            <h1 class="display-5">{{ _('image/images', variant='1') |capitalize }}</h1>
                                            <div class="d-flex align-items-center">
                                                <i class="fa fa-folder-open fa-lg text-warning mx-2" aria-hidden="true"></i>
                                                <strong><samp class="text-truncate"
      title="{{ images_store }}{{ X }}{{ carrousel }}">{{ images_store }}{{ X }}{{ carrousel }}{{ X }}</samp></strong>
                                                <div class="ml-auto">({{ carrousel_img_nbr }})</div>
                                            </div>
                                            {# foreach not implemented yet #}
                                        {% endif %}
                                        {% if carrousel_old_img_nbr > 0 %}
                                            <h1 class="display-5">{{ _('saved images', variant='1') |capitalize }}</h1>
                                            <div class="d-flex align-items-center">
                                                <i class="fa fa-folder-open fa-lg text-warning mx-2" aria-hidden="true"></i>
                                                <strong><samp class="text-truncate"
      title="{{ images_store }}{{ X }}{{ carrousel }}{{ X }}saved{{ X }}">{{ images_store }}{{ X }}{{ carrousel }}{{ X }}saved{{ X }}</samp></strong>
                                                <div class="ml-auto">({{ carrousel_old_img_nbr }})</div>
                                            </div>
                                            {# foreach not implemented yet #}
                                        {% endif %}
                                    </div>
                                </div>
                                {% if e.em != "" %}
                                    <div role="alert"
                                         class="alert alert-dismissible fade show alert-{{ alert_color() }} mt-3">
                                        <strong>{{ alert_header() }}{{ _(":") }}</strong> {{ alert_content() }}
                                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                {% endif %}
                            {% endif %}
                            {% include 'trl.html.j2' %}
                            {% include 'copyr.html.j2' %}
                        </div>
                        {% include 'js.html.j2' %}
                        {{ query_time }}
                        {% macro input_snd(xxx, yyy) %}
                            $('.xxx').change(function() {
                            let fileName = $(this).val().split('\\').pop();
                            $(this).next('.custom-file-label').addClass("selected").html(fileName);
                            $('.yyy').prop('disabled', false);
                            {% if "yyy" == "btn-quick-upload" %}
                                $('#image_note, #image_source').prop('disabled', false);
                                $('.submit-button').prop('disabled', false);
                                $('#image_url, #image_name').prop('disabled', true).val('');
                                $('#btn-cancel-edit').removeClass('d-none').addClass('d-flex align-items-center');
                                $('#image_note').focus();
                            {% endif %}
                            {% raw %}
                                });
                            {% endraw %}
                        {% endmacro %}
                        <script>
                            $(function() {
                                {
                                    {
                                        input_snd("custom-portrait", "snd-btn-portrait")
                                    }
                                } {
                                    {
                                        input_snd("custom-blason", "snd-btn-blason")
                                    }
                                } {
                                    {
                                        input_snd("custom-others", "btn-quick-upload")
                                    }
                                }
                                $('{{ _('
                                    data - toggle = "tooltip"
                                    ') }}').tooltip({
                                    html: true,
                                    boundary: 'window'
                                });
                                // Gestion du bouton d'envoi rapide (le premier bouton)
                                $('.btn-quick-upload').click(function() {
                                    if ($('#others_file').val()) {
                                        $('form').submit();
                                    }
                                });
                                // Gestion de l'URL d'image
                                $('#image_url').on('input', function() {
                                    if (this.value.length) {
                                        // Si une URL est saisie
                                        $('.btn-quick-upload').prop('disabled', false);
                                        $('#image_note, #image_source').prop('disabled', false);
                                        $('.submit-button').prop('disabled', false);
                                        // Désactiver l'input de fichier puisqu'une URL est saisie
                                        $('#others_file').prop('disabled', true);
                                        $('.custom-file-label').html('{{ _('
                                            select ')|capitalize }} {{ _('
                                            image / images ', variant='
                                            0 ') }}');
                                        $('#image_name').prop('disabled', false);
                                        // Afficher le bouton d'annulation
                                        $('#btn-cancel-edit').removeClass('d-none').addClass('d-flex align-items-center');
                                    } else {
                                        // Si l'URL est vidée et qu'il n'y a pas de fichier
                                        if (!$('#others_file').prop('disabled')) {
                                            $('.btn-quick-upload').prop('disabled', true);
                                            $('#image_note, #image_source').prop('disabled', true);
                                            $('.submit-button').prop('disabled', true);
                                            // Cacher le bouton d'annulation si on est revenu à l'état initial
                                            $('#btn-cancel-edit').addClass('d-none');
                                            $('#image_name').prop('disabled', true).val('');
                                        }
                                    }
                                });
                                // Activer le bouton du bas si des métadonnées sont saisies
                                $('#image_name, #image_note, #image_source').on('input', function() {
                                    if ($('#others_file').val() || $('#image_url').val().trim() !== '' || $(this).val().trim() !== '') {
                                        $('.submit-button').prop('disabled', false);
                                    }
                                });
                                // Désactiver les champs après l'envoi
                                $('form').on('submit', function() {
                                    // Ne pas réinitialiser tout de suite si on est en mode édition
                                    if ($('#mode_2').val() !== 'note') {
                                        setTimeout(function() {
                                            $('#image_note, #image_source').prop('disabled', true);
                                        }, 100);
                                    }
                                });
                                // Annuler l'édition
                                $('#btn-cancel-edit').click(function() {
                                    // Réinitialiser les champs
                                    $('#image_note, #image_source').val('').prop('disabled', true);
                                    $('#file_name_2').val('');
                                    $('#mode_2').val('carrousel');
                                    $('#which_img_show').text('{{ _('
                                        send image with note and source ')|capitalize }}');
                                    $('.submit-button').prop('disabled', true);
                                    // Réinitialiser les champs spécifiques
                                    $('#others_file').val('').prop('disabled', false);
                                    $('.custom-file-label').html('{{ _('
                                        select ')|capitalize }} {{ _('
                                        image / images ', variant='
                                        0 ') }}');
                                    $('#image_url').val('').prop('disabled', false);
                                    $('#image_name').val('').prop('disabled', true);
                                    $('.btn-quick-upload').prop('disabled', true);
                                    // Cacher le bouton d'annulation
                                    $(this).addClass('d-none').removeClass('d-flex');
                                });
                            });
                            const updateTextareaSize = () => {
                                setTimeout(() => {
                                    autosize.update($('textarea'));
                                }, 0);
                            };

                            function formatButtonText(noteText, imageName, maxLen = 37) {
                                const ext = imageName.lastIndexOf('.');
                                const name = ext !== -1 ? imageName.slice(0, ext) : imageName;
                                const truncName = name.length > maxLen ?
                                    name.slice(0, maxLen - 3) + '{{ _('…
                                ') }}': name;
                                const fullText = `${noteText}\n${truncName}${ext !== -1 ? imageName.slice(ext) : ''}`;
                                if (name.length > maxLen) {
                                    $('#which_img_show').css('white-space', 'pre-line');
                                } else {
                                    $('#which_img_show').css('white-space', 'normal');
                                }
                                return fullText;
                            }
                            const editImageNote = (cnt, name) => {
                                const noteData = $(`#source_${cnt}`).data('note');
                                const sourceData = $(`#source_${cnt}`).data('source');
                                // Désactiver l'input de fichier et l'URL pendant l'édition
                                $('#others_file').prop('disabled', true);
                                $('#image_url, #image_name').prop('disabled', true);
                                // Désactiver le bouton d'envoi rapide pendant l'édition
                                $('.btn-quick-upload').prop('disabled', true);
                                // Afficher le bouton d'annulation
                                $('#btn-cancel-edit').removeClass('d-none').addClass('d-flex align-items-center');
                                $('#image_note').val(noteData || '').prop('disabled', false).focus();
                                $('#image_source').val(sourceData || '').prop('disabled', false);
                                updateTextareaSize();
                                $('#image_note').focus();
                                $('#file_name_2').val(name);
                                $('#mode_2').val('note');
                                const buttonText = noteData ?
                                    formatButtonText(`{{ _('update image note')|capitalize }}`, name) :
                                    formatButtonText(`{{ _('add note')|capitalize }}/{{ _('source/sources', variant='0') }}`, name);
                                $('#which_img_show').text(buttonText);
                                $('.submit-button').prop('disabled', false);
                                $('#image_note, #image_source').off('input').on('input', function() {
                                    $('.submit-button').prop('disabled', !this.value.length);
                                    updateTextareaSize();
                                });
                                return false;
                            };
                            $('#image_url').on('input', function() {
                                const url = this.value.trim();
                                const nameField = $('#image_name');
                                if (url && !nameField.val()) {
                                    // Extraire le nom depuis l'URL pour prévisualisation
                                    const filename = url.split('/').pop().split('?') {
                                        {
                                            _('0')
                                        }
                                    };
                                    if (filename && filename.includes('.')) {
                                        nameField.attr('placeholder', filename + ' (auto)');
                                    }
                                }
                            });
                        </script>
                    </body>
                </html>
            {% endwith %}
        {% endwith %}
    {% endwith %}
{% endwith %}
