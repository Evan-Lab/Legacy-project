name: E2E Tests on GeneWeb

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Install OCaml & system dependencies
        run: |
          sudo apt update
          sudo apt install -y opam ocaml make git curl \
            libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev \
            libnss3 libxss1 libasound2t64 xvfb

      - name: Initialize opam and install ocamlfind
        run: |
          echo "ðŸ”§ Initializing OPAM..."
          opam init -y --disable-sandboxing
          eval $(opam env)
          echo "ðŸ“¦ Installing OCamlfind..."
          opam install -y ocamlfind
          echo "âœ… OCaml environment setup complete"

      - name: ðŸ§± Build GeneWeb from source
        run: |
          echo "ðŸ“¥ Cloning GeneWeb repository..."
          git clone https://github.com/geneweb/geneweb.git
          echo "\nðŸ“‚ Contents of current directory:"
          ls
          echo "\nðŸš€ Entering GeneWeb directory..."
          cd geneweb
          echo "ðŸ“‚ Contents of GeneWeb directory:"
          ls
          echo "\nâš™ï¸ Configuring GeneWeb..."
          ocaml ./configure.ml
          echo "ðŸ“‚ Contents after configuration:"
          ls
          echo "\nðŸ—ï¸ Building GeneWeb distribution..."
          make clean distrib
          echo "\nðŸ“¦ Entering distribution directory..."
          cd distribution/
          echo "ðŸ“‚ Distribution contents:"
          ls

      - name: ðŸš€ Start GeneWeb server
        run: |
          echo "ðŸ“ Creating GeneWeb data directory..."
          mkdir -p ~/geneweb-data
          echo "ðŸš€ Starting GeneWeb server daemon..."
          nohup geneweb -daemon -hd ~/geneweb-data -bd ~/geneweb-data -port 2317 &
          echo "â³ Waiting for GeneWeb to start..."
          for i in {1..10}; do
            if curl -sSf http://localhost:2317 >/dev/null; then
              echo "âœ… GeneWeb is running!"
              break
            fi
            sleep 3
          done

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ðŸ“¦ Install Cypress dependencies
        run: |
          cd tests
          npm ci

      - name: ðŸ§ª Run Cypress E2E tests
        uses: cypress-io/github-action@v6
        with:
          working-directory: tests
          start: npx cypress run --config baseUrl=http://localhost:2317
          wait-on: 'http://localhost:2317'
          browser: chrome
